// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ USUARIOS ============
model User {
  id             String   @id @default(cuid())
  stellarAddress String   @unique
  displayName    String?
  role           String?  // EMPLOYER | FREELANCER | BOTH
  balance        Float?   @default(0)
  bio            String?
  createdAt      DateTime @default(now())
  lastSeenAt     DateTime @updatedAt
  metadata       Json?

  // Relaciones con nombres únicos
  jobs           Job[]     @relation("EmployerJobs")
  applications   Application[] @relation("FreelancerApplications")
  agreements     Agreement[] @relation("FreelancerAgreements") // Como freelancer
  employerAgreements Agreement[] @relation("EmployerAgreements") // Como empleador
  notifications  Notification[] @relation("UserNotifications")
  notificationPreferences NotificationPreferences? @relation("UserNotificationPreferences")
}

// ============ TRABAJOS ============
model Job {
  id               String   @id @default(cuid())
  employerId       String
  employerAddress  String
  title            String
  description      String
  deliverables     String?
  requirements     String?
  amount           Float
  estimatedDays    Int?
  deadline         DateTime?
  
  status           String   @default("DRAFT")
  
  // Trustless Work
  escrowContractId String?  @unique
  escrowAddress    String?
  engagementId     String?
  
  // Timestamps
  createdAt        DateTime @default(now())
  fundedAt         DateTime?
  publishedAt      DateTime?
  completedAt      DateTime?
  cancelledAt      DateTime?
  metadata         Json?  

  // Relaciones
  employer         User     @relation("EmployerJobs", fields: [employerId], references: [id])
  applications     Application[]
  agreement        Agreement?
  transactions     Transaction[]
}

// ============ APLICACIONES ============
model Application {
  id                    String   @id @default(cuid())
  jobId                 String
  freelancerId          String
  freelancerAddress     String
  coverLetter           String?
  portfolioUrl          String?
  proposedDeliveryDate  DateTime?
  status                String   @default("PENDING")
  
  appliedAt             DateTime @default(now())
  acceptedAt            DateTime?
  rejectedAt            DateTime?

  // Relaciones
  job                   Job      @relation(fields: [jobId], references: [id])
  freelancer            User     @relation("FreelancerApplications", fields: [freelancerId], references: [id])
}

// ============ ACUERDOS ============
model Agreement {
  id                    String   @id @default(cuid())
  jobId                 String   @unique
  employerId            String
  employerAddress       String
  freelancerId          String
  freelancerAddress     String
  escrowContractId      String   @unique
  
  status                String   @default("ACTIVE")
  
  deliveryUrl           String?
  deliveryNote          String?
  deliveryFiles         Json?
  
  employerApproved      Boolean  @default(false)
  freelancerConfirmed   Boolean  @default(false)
  
  createdAt             DateTime @default(now())
  deliveredAt           DateTime?
  employerApprovedAt    DateTime?
  freelancerConfirmedAt DateTime?
  completedAt           DateTime?
  disputedAt            DateTime?

  // Relaciones con nombres únicos
  job                   Job      @relation(fields: [jobId], references: [id])
  employer              User     @relation("EmployerAgreements", fields: [employerId], references: [id])
  freelancer            User     @relation("FreelancerAgreements", fields: [freelancerId], references: [id])
  transactions          Transaction[]
}

// ============ TRANSACCIONES ============
model Transaction {
  id            String   @id @default(cuid())
  agreementId   String?
  jobId         String?
  
  type          String
  amount        Float
  txHash        String?  @unique
  status        String   @default("PENDING")
  
  fromAddress   String?
  toAddress     String?
  
  metadata      Json?
  
  createdAt     DateTime @default(now())
  confirmedAt   DateTime?

  agreement     Agreement? @relation(fields: [agreementId], references: [id])
  job           Job?       @relation(fields: [jobId], references: [id])
}

// ============ NOTIFICACIONES ============
model Notification {
  id         String   @id @default(cuid())
  userId     String
  type       String
  title      String
  message    String
  actionUrl  String?
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())

  user       User     @relation("UserNotifications", fields: [userId], references: [id])
}

// ============ PREFERENCIAS DE NOTIFICACIÓN ============
model NotificationPreferences {
  id                  String   @id @default(cuid())
  userId              String   @unique
  contactMethod       String?
  contactValue        String?
  notifyOnApplication Boolean  @default(true)
  notifyOnDelivery    Boolean  @default(true)
  notifyOnPayment     Boolean  @default(true)
  
  user                User     @relation("UserNotificationPreferences", fields: [userId], references: [id])
}
